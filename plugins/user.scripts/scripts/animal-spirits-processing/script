#!/bin/bash

INPUT_DIR="/mnt/user/data/media/podcast/Animal Spirits Podcast"
OUTPUT_DIR="/mnt/user/data/media/podcast/Animal Spirits Podcast - No ads"
TIMESTAMP_FILE="/boot/config/plugins/user.scripts/scripts/animal-spirits-processing/last_run_timestamp"
DRY_RUN=false

# Parse arguments
for arg in "$@"; do
    if [ "$arg" == "--dry-run" ]; then
        DRY_RUN=true
    fi
done

# Check if input directory exists
if [ ! -d "$INPUT_DIR" ]; then
    echo "Error: Input directory '$INPUT_DIR' does not exist"
    exit 1
fi

# Create output directory if it doesn't exist
if [ "$DRY_RUN" = false ]; then
    mkdir -p "$OUTPUT_DIR"
fi

# Get the current time before processing
current_run_time=$(date +"%Y-%m-%d %H:%M:%S")

# Read the last run timestamp
if [ -f "$TIMESTAMP_FILE" ]; then
    last_run_time=$(cat "$TIMESTAMP_FILE")
    echo "Last run time: $last_run_time"
    find_opts="-newermt \"$last_run_time\""
else
    echo "Timestamp file not found. Processing all files."
    last_run_time="" # Process all files if timestamp file doesn't exist
    find_opts=""
fi

echo "Processing files from $INPUT_DIR to $OUTPUT_DIR..."
echo "Dry run mode: $DRY_RUN"
echo "Processing files modified after: ${last_run_time:-'the beginning of time'}"

# Find all files modified after the last run time in the input directory
# Note: Using eval here to correctly handle the find_opts which may contain spaces and quotes
eval find "\"$INPUT_DIR\"" -type f -name "*.mp3" $find_opts | while read -r file; do
    filename=$(basename "$file")
    echo "Processing: $filename"

    # Check if the filename contains a specific string (e.g., "keyword")
    if [[ "${filename,,}" == *"talk your book"* ]]; then
        echo "✗ Skipping file: $filename"
    else
        if [ "$DRY_RUN" = false ]; then
            cp "$file" "$OUTPUT_DIR/"
            if [ $? -eq 0 ]; then
                echo "✓ Successfully copied: $filename"
            else
                echo "✗ Error copying: $filename (Error code: $?)"
            fi
        else
            echo "✓ (Dry run) Would copy: $filename"
        fi
    fi
done

# Update the timestamp file with the current run time if not a dry run
if [ "$DRY_RUN" = false ]; then
    echo "$current_run_time" > "$TIMESTAMP_FILE"
    echo "Updated last run timestamp to: $current_run_time"
fi

echo "All files processed."
